# Avahi deamon reflector:
#  https://community.home-assistant.io/t/containers-avoiding-privileged-and-host-network-as-much-as-possible/60792/6
- name: Install Avahi
  pacman:
    name: "avahi"
    state: "present"

- name: Disable multicast from systemd-resolved
  register: "resolved_config"
  lineinfile:
    path: "/etc/systemd/resolved.conf"
    regexp: "^MulticastDNS="
    insertafter: '^#MulticastDNS='
    line: "MulticastDNS=no"
    state: "present"

- name: Enable systemd-resolved
  register: "resolved_service"
  systemd:
    name: "systemd-resolved.service"
    state: "started"
    enabled: yes
- name: Restart systemd-resolved
  when: "resolved_config.changed and not resolved_service.changed"
  systemd:
    name: "systemd-resolved.service"
    state: "restarted"

- name: Restrict Avahi interfaces
  register: "avahi_config_1"
  lineinfile:
    path: "/etc/avahi/avahi-daemon.conf"
    regexp: "^allow-interfaces="
    insertafter: '^#allow-interfaces=eth0'
    line: "allow-interfaces=br-public,{{ wan_if }}"
    state: "present"
- name: Enable Avahi mDNS reflector
  register: "avahi_config_2"
  lineinfile:
    path: "/etc/avahi/avahi-daemon.conf"
    regexp: "^enable-reflector="
    insertafter: '^#enable-reflector='
    line: "enable-reflector=yes"
    state: "present"

- name: Enable Avahi Daemon
  register: "avahi_service"
  systemd:
    name: "avahi-daemon.service"
    state: "started"
    enabled: yes
- name: Restart Avahi Daemon
  when: "(avahi_config_1.changed or avahi_config_2.changed) and not avahi_service.changed"
  systemd:
    name: "avahi-daemon.service"
    state: "restarted"

- name: Copy NFTables configuration
  register: "nftables_config"
  template:
    src: "etc/nftables.conf.j2"
    dest: "/etc/nftables.conf"
    force: yes
    owner: "root"
    group: "root"
    mode: 0600
    validate: "nft -c -f %s"

- name: Enable NFTables
  register: "nftables_service"
  systemd:
    name: "nftables.service"
    state: "started"
    enabled: yes
- name: Reload NFTables
  when: "nftables_config.changed and not nftables_service.changed"
  systemd:
    name: "nftables.service"
    state: "reloaded"
