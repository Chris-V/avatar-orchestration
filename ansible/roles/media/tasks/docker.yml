- name: Install docker packages
  pacman:
    name: docker docker-compose
    state: present

- name: Enable Docker
  systemd:
    name: docker.service
    state: started
    enabled: yes

- name: Create data directories
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "docker-appdata"
    group: "{{ item.group }}"
    mode: 0775
  loop:
    - { path: '{{ backups_dir }}', group: 'docker-appdata' }
    - { path: '{{ series_dir }}', group: 'media' }
    - { path: '{{ movies_dir }}', group: 'media' }
    - { path: '{{ downloads_dir }}', group: 'data' }
    - { path: '{{ deluge_completed_dir }}', group: 'data' }
    - { path: '{{ deluge_downloads_dir }}', group: 'data' }
    - { path: '{{ jackett_downloads_dir }}', group: 'data' }
    - { path: '{{ plex_transcode_dir }}', group: 'docker-appdata' }

- name: Create docker directories
  file:
    path: '{{ item }}'
    state: directory
    owner: root
    group: docker
    mode: 0770
  loop:
    - '{{ docker_srv_dir }}'

- name: Copy docker images
  copy:
    src: 'docker-images'
    dest: '{{ docker_srv_dir }}'
    owner: root
    group: docker
    directory_mode: "ug=rwx,o="
    mode: "ug+rw,o=" # Preserve exec. bit where applicable

- name: Copy docker compose
  template:
    src: "docker-compose.yml.j2"
    dest: '{{ docker_srv_dir }}/docker-compose.yml'
    owner: root
    group: docker
    mode: 0660
    validate: 'docker-compose -f %s config'

- name: Copy initial app configs
  unarchive:
    creates: '{{ docker_appdata_dir }}'
    src: '{{ appdata_archive }}'
    dest: '{{ docker_srv_dir }}'

- name: Copy managed app configs
  copy:
    src: '{{ item.name }}'
    dest: '{{ docker_appdata_dir }}'
    owner: docker-appdata
    group: docker-appdata
    directory_mode: "u=rwx,g=rx,o="
    mode: "u+rw,g+r-w,o=" # Preserve exec. bit where applicable
  loop:
    - { name: 'appdata/backup-scheduler' }

- name: Populate managed app configs
  template:
    src: 'appdata/{{ item.filename }}.j2'
    dest: '{{ docker_appdata_dir }}/{{ item.filename }}'
    owner: 'docker-appdata'
    group: 'docker-appdata'
    mode: 0640
  loop:
    - { filename: 'glances.conf' }
    - { filename: 'traefik.toml' }
