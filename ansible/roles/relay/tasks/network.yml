- name: Disable wireless power saving mode
  notify: reload udev
  ansible.builtin.copy:
    dest: "/etc/udev/rules.d/81-wifi-powersave.rules"
    owner: "root"
    group: "root"
    mode: 0644
    content: |
      ACTION=="add", SUBSYSTEM=="net", KERNEL=="wl*", RUN+="/usr/bin/iw dev $name set power_save off"

- name: Copy NFTables configuration
  register: "nftables_config"
  ansible.builtin.template:
    src: "etc/nftables.conf.j2"
    dest: "/etc/nftables.conf"
    force: yes
    owner: "root"
    group: "root"
    mode: 0600
    validate: "nft -c -f %s"

- name: Enable NFTables
  register: "nftables_service"
  ansible.builtin.systemd:
    name: "nftables.service"
    state: "started"
    enabled: yes
- name: Reload NFTables
  when: "nftables_config.changed and not nftables_service.changed"
  ansible.builtin.systemd:
    name: "nftables.service"
    state: "reloaded"

- name: Copy network configurations
  register: "network_configs"
  loop:
    - { filename: "wired.network" }
    - { filename: "wireless.network" }
  ansible.builtin.copy:
    src: "etc/systemd/network/{{ item.filename }}"
    dest: "/etc/systemd/network/{{ item.filename }}"
    owner: "root"
    group: "root"
    mode: "u=rw,go=r"

- name: Enable systemd-networkd
  register: "networkd_service"
  ansible.builtin.systemd:
    name: "systemd-networkd.service"
    state: "started"
    enabled: yes
- name: Restart systemd-networkd
  when: "network_configs.changed and not networkd_service.changed"
  ansible.builtin.systemd:
    name: "systemd-networkd.service"
    state: "restarted"
