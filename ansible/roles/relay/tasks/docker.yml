- name: Install docker packages
  pacman:
    name: "docker docker-compose"
    state: "present"

- block:
    - file:
        state: "directory"
        path: "/etc/systemd/system/docker.service.d"
        owner: "root"
        group: "root"
        mode: 0755
    - name: Copy docker service unit overrides
      copy:
        dest: "/etc/systemd/system/docker.service.d/10-args.conf"
        owner: "root"
        group: "root"
        mode: 0644
        content: |
          [Service]
          ExecStart=
          ExecStart=/usr/bin/dockerd -H fd:// --iptables=false --bip={{ docker_net_host }} --fixed-cidr={{ docker_net_host }}
      notify:
        - reload systemd
        - restart docker

- name: Enable Docker
  systemd:
    name: "docker.service"
    state: "started"
    enabled: yes

- name: Create docker directories
  file:
    path: "{{ item.path }}"
    state: "directory"
    owner: "root"
    group: "docker"
    mode: 0770
  loop:
    - { path: '{{ docker_apps_dir }}' }

- name: Copy docker images
  copy:
    src: 'docker-images'
    dest: '{{ docker_apps_dir }}'
    owner: "root"
    group: "docker"
    directory_mode: "ug=rwx,o="
    mode: "preserve"

- name: Copy docker compose
  template:
    src: "docker-compose.yml.j2"
    dest: '{{ docker_apps_dir }}/docker-compose.yml'
    owner: "root"
    group: "docker"
    mode: 0660
    validate: 'docker-compose -f %s config'

- name: Copy app data
  copy:
    src: 'appdata/'
    dest: '{{ docker_appdata_dir }}'
    owner: "root"
    group: "docker"
    directory_mode: 0750
    mode: 0640
- name: Copy app data templates
  template:
    src: 'appdata/{{ item.filename }}.j2'
    dest: '{{ docker_appdata_dir }}/{{ item.filename }}'
    owner: 'root'
    group: 'docker'
    mode: 0640
  loop:
    - { filename: 'traefik.toml' }

- name: Copy host-specific plant gateway config
  template:
    src: 'host_files/{{ inventory_hostname }}/plantgw.yaml.j2'
    dest: '{{ docker_appdata_dir }}/plantgw/plantgw.yaml'
    owner: "root"
    group: "docker"
    mode: 0640
