version: "3.7"

x-timezone: &timezone "{{ timezone }}"
x-proxy-enabled: &proxy-enabled
  traefik.enable: "true"
  traefik.docker.network: "public"

networks:
  public:

services:
  proxy:
    container_name: proxy
    image: "traefik:alpine"
    restart: "unless-stopped"
    environment:
      TZ: *timezone
    labels:
      <<: *proxy-enabled
      traefik.proxy.backend: "proxy"
      traefik.proxy.port: 8080
      traefik.proxy.frontend.rule: "Host:traefik.{{ internal_hostname }}"
    networks:
      public:
    ports:
      - "80:80"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "{{ docker_appdata_dir }}/traefik.toml:/traefik.toml:ro"

  glances:
    container_name: glances
    build:
      context: "{{ docker_apps_dir }}/docker-images/glances"
    image: "avatary/glances"
    command: "-w"
    pid: "host"
    restart: "unless-stopped"
    environment:
      TZ: *timezone
    labels:
      <<: *proxy-enabled
      traefik.glances.backend: "glances"
      traefik.glances.port: 61208
      traefik.glances.frontend.rule: "Host:glances.{{ internal_hostname }}"
    logging:
      driver: "json-file"
      options:
        max-size: "200k"
        max-file: "1"
    networks:
      public:
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"

  plant-gateway:
    container_name: plant-gateway
    build:
      context: "{{ docker_apps_dir }}/docker-images/plant-gateway"
    image: "avatary/plant-gateway"
    network_mode: "host"
    restart: "unless-stopped"
    environment:
      TZ: *timezone
    volumes:
      - "{{ docker_appdata_dir }}/plantgw:/config:ro"
